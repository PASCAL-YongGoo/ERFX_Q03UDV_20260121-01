# PLC 주소 명세서 (D7xxx & D8xxx)

## 개요

이 문서는 Edge 프로그램과 Mitsubishi Q03UDV PLC 간의 통신 프로토콜을 정의합니다.

- **D7xxx**: Edge → PLC (Write 영역)
- **D8xxx**: PLC → Edge (Read 영역)

---

## 1. 주소 정의

### 1.1 D7xxx - Write 영역 (Edge → PLC)

| 주소 | 이름 | 값 | 설명 |
|------|------|-----|------|
| **D7000** | Edge Ready | 0: 엣지 준비 안됨<br>1: 엣지 준비 됨 | 프로그램 시작 시 1, 종료 시 0 |
| **D7001** | Heart Beat | 0 ↔ 1 토글 | 1초마다 토글하여 통신 상태 확인 |
| **D7002** | 판정 중 | 0: 동작 없음<br>1: 판정 중 | D8003=1 수신 시 0으로 초기화 |
| **D7003** | 판정 결과 | 1: OK<br>2: NG | D8003=1 수신 시 0으로 초기화<br>솔팅 전 데이터가 0이면 NG |
| D7004~D7008 | - | - | 예약 |
| **D7009** | 알람 | - | 알람 발생 신호 |
| D7010~D7019 | - | - | 예약 |
| **D7020** | 상태 변화 | 1: 수동<br>2: 자동 | D8020=1 수신 시 0으로 초기화 |
| **D7021** | 알람 초기화 | 1: 알람 초기화 | D8021=1 수신 시 0으로 초기화 |

### 1.2 D8xxx - Read 영역 (PLC → Edge)

| 주소 | 이름 | 값 | 설명 |
|------|------|-----|------|
| **D8000** | PLC Ready | 0: PLC 준비 안됨<br>1: PLC 준비 됨 | PLC 상태 확인 |
| D8001~D8002 | - | - | 예약 |
| **D8003** | 수신 완료 | 1: 판정 데이터 수신 완료 | D7002, D7003 초기화 시 0으로 변경 |
| D8004~D8006 | - | - | 예약 |
| **D8007** | 상태 | 1: 수동<br>2: 자동 | 현재 PLC 운전 모드 |
| **D8008** | 센서 값 | 0x0 ~ 0xF | 박스 위치 확인용 (비트 플래그) |
| D8009~D8019 | - | - | 예약 |
| **D8020** | 수신 완료 | 1: 상태 변화 수신 완료 | D7020 초기화 트리거 |
| **D8021** | 수신 완료 | 1: 알람 초기화 수신 완료 | D7021 초기화 트리거 |

---

## 2. 프로그램 흐름

### 2.1 Write 동작 (Edge → PLC)

| 조건 | 주기 | 동작 | 주소 | 값 |
|------|------|------|------|-----|
| 프로그램 시작 | 1회 | PLC Write | D7000 | 1 |
| 프로그램 종료 | 1회 | PLC Write | D7000 | 0 |
| 바코드 센서 ON | 1회 | PLC Write | D7002 | 1 |
| 터널 아웃 센서 ON | 1회 | PLC Write | D7003 | 1: OK / 2: NG |
| 수동/자동 변경 버튼 | 화면 클릭 | PLC Write | D7020 | 1: 수동 / 2: 자동 |
| 알람 초기화 버튼 | 화면 클릭 | PLC Write | D7021 | 1 |
| Heart Beat | 1초마다 | PLC Write | D7001 | 0 ↔ 1 토글 |

### 2.2 Read 동작 (PLC → Edge)

| 조건 | 주기 | 동작 | 주소 | 행동 |
|------|------|------|------|------|
| PLC 상태 확인 | 10ms | PLC Read | D8000 | 0: 검사 신호 무시<br>1: 정상 동작 |
| 판정 수신완료 확인<br>(D7003 쓴 이후) | 10ms | PLC Read | D8003 | 1: D7002, D7003을 0으로 초기화 |
| 수동/자동 확인 | 10ms | PLC Read | D8007 | 1: 수동 (서버 업로드 안함)<br>2: 자동 (서버 업로드) |
| 센서 값 확인 | 10ms | PLC Read | D8008 | 비트별 박스 위치 확인<br>검사 트리거 신호로 활용 |
| 상태변화 수신완료 확인<br>(D7020 쓴 이후) | 10ms | PLC Read | D8020 | 1: D7020을 0으로 초기화 |

---

## 3. 핸드셰이크 패턴

### 3.1 공통 패턴

```
Edge                              PLC
  │                                │
  ├──[Write D7xxx = value]────────►│
  │                                │
  │◄──[Read D8xxx == 1 (ACK)]──────┤
  │                                │
  ├──[Write D7xxx = 0 (초기화)]───►│
  │                                │
  │◄──[D8xxx 자동으로 0 변경]──────┤
```

### 3.2 판정 흐름 (D7002/D7003 ↔ D8003)

```
[바코드 센서 ON]
    │
    ├──► D7002 = 1 (판정 중)
    │
    ├──► [판정 완료 후 - 터널 아웃 센서 ON]
    │         │
    │         └──► D7003 = 1(OK) 또는 2(NG)
    │
    └──► [10ms 폴링] D8003 == 1 확인
              │
              └──► D7002 = 0, D7003 = 0 (초기화)
```

### 3.3 상태 변화 (D7020 ↔ D8020)

```
[사용자가 수동/자동 전환 클릭]
    │
    ├──► D7020 = 1(수동) 또는 2(자동)
    │
    └──► [10ms 폴링] D8020 == 1 확인
              │
              └──► D7020 = 0 (초기화)
```

### 3.4 알람 초기화 (D7021 ↔ D8021)

```
[사용자가 알람 초기화 클릭]
    │
    ├──► D7021 = 1
    │
    └──► [10ms 폴링] D8021 == 1 확인
              │
              └──► D7021 = 0 (초기화)
```

---

## 4. 비즈니스 로직

### 4.1 D8007 수동/자동 모드 영향

| 모드 | D8007 값 | 서버 업로드 | 판정 동작 |
|------|----------|-------------|-----------|
| **수동** | 1 | ❌ 안함 | 판정만 수행 |
| **자동** | 2 | ✅ 업로드 | 판정 + 서버 전송 |

### 4.2 D8008 센서 비트 활용

박스 위치를 비트 플래그로 표현 (0x0 ~ 0xF):

| 비트 | 위치 | 값 |
|------|------|-----|
| Bit 0 | 위치 0 | 0x1 |
| Bit 1 | 위치 1 | 0x2 |
| Bit 2 | 위치 2 | 0x4 |
| Bit 3 | 위치 3 | 0x8 |

**예시**: D8008 = 0x05 → 위치 0과 위치 2에 박스 있음

**트리거 활용**:
- 바코드 센서 ON → 바코드/RFID 트리거
- 터널 아웃 센서 ON → 판정 결과 전송 트리거

---

## 5. 전체 시퀀스

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           ERFX 시스템 흐름                                │
└──────────────────────────────────────────────────────────────────────────┘

[프로그램 시작]
      │
      ├──► D7000 = 1 (Edge Ready)
      │
      └──► Heart Beat 시작 (1초마다 D7001 토글)


[박스 진입 - 바코드 센서 ON]
      │
      ├──► D7002 = 1 (판정 중)
      │
      ├──► 바코드 리더 트리거 → 바코드 데이터 수신
      │
      ├──► RFID 리더 트리거 → RFID 데이터 수신
      │
      └──► 판정 로직 실행 (OK/NG 결정)


[박스 퇴장 - 터널 아웃 센서 ON]
      │
      ├──► D7003 = 1(OK) 또는 2(NG)
      │
      ├──► [폴링] D8003 == 1 대기
      │         │
      │         └──► D7002 = 0, D7003 = 0 (초기화)
      │
      └──► 다음 박스 대기


[사용자 조작 - 수동/자동 전환]
      │
      ├──► D7020 = 1(수동) 또는 2(자동)
      │
      ├──► [폴링] D8020 == 1 대기
      │         │
      │         └──► D7020 = 0 (초기화)


[사용자 조작 - 알람 초기화]
      │
      ├──► D7021 = 1
      │
      ├──► [폴링] D8021 == 1 대기
      │         │
      │         └──► D7021 = 0 (초기화)


[프로그램 종료]
      │
      └──► D7000 = 0 (Edge Not Ready)
```

---

## 6. 자동 처리 항목

우리 프로그램에서 자동으로 처리되는 항목입니다. 외부 토픽 연동 불필요.

| 항목 | 주소 | 값 | 트리거 |
|------|------|-----|--------|
| Edge Ready 설정 | D7000 | 1 | 프로그램 시작 시 |
| Edge Ready 해제 | D7000 | 0 | 프로그램 종료 시 |
| Heart Beat | D7001 | 0 ↔ 1 | 1초마다 토글 |
| 판정 데이터 초기화 | D7002, D7003 | 0 | D8003 = 1 감지 시 |
| 상태 변화 초기화 | D7020 | 0 | D8020 = 1 감지 시 |
| 알람 초기화 완료 | D7021 | 0 | D8021 = 1 감지 시 |

---

## 7. 주소 매핑 요약

```
┌─────────────────────────────────────────────────────────────┐
│                    Edge Program                              │
├─────────────────────────────────────────────────────────────┤
│  WRITE (D7xxx)              READ (D8xxx)                    │
│  ─────────────              ──────────────                  │
│  D7000: Edge Ready    ←→    D8000: PLC Ready               │
│  D7001: Heart Beat                                          │
│  D7002: 판정 중        →    D8003: 수신 완료 (ACK)          │
│  D7003: 판정 결과      →                                    │
│                             D8007: 상태 (수동/자동)          │
│                             D8008: 센서 값 (위치)            │
│  D7009: 알람                                                │
│  D7020: 상태 변화      →    D8020: 수신 완료 (ACK)          │
│  D7021: 알람 초기화    →    D8021: 수신 완료 (ACK)          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Mitsubishi Q03UDV PLC                    │
└─────────────────────────────────────────────────────────────┘
```
